# -*- coding: utf-8 -*-

# Form implementation generated from reading ui file 'mainwindow.ui'
#
# Created by: PyQt5 UI code generator 5.15.0
#
# WARNING: Any manual changes made to this file will be lost when pyuic5 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt5 import QtCore, QtGui, QtWidgets
from PyQt5.QtCore import *
from PyQt5.QtWidgets import QWidget,QApplication, QInputDialog, QLineEdit,QLabel,QFrame,QTextEdit,QMessageBox
import sys
from monitorServer import MonitorServer
from yamlTool import Yaml_Tool
from robotState import RobotState
from PyQt5.QtGui import QPixmap


class GUI(QWidget):
    def __init__(self):
        super(GUI,self).__init__()
        self.getObjectNames()
        self.labelArray=[]
        labelWidth=100
        labelHeight=40
        label_y=80
        label_x=50
        
        objectIndex=0
        for i in range(0,40):
            _label=QLabel(self)
            _label.setAlignment(Qt.AlignCenter)
            self.labelArray.append(_label)
            if i%5==0:
                label_y=80
                label_x=label_x+labelWidth+20
                _label.setText(str(int(i/5+1))+'拉')
            else:
                _label.setObjectName(self.objectNames[objectIndex])
                # print(self.objectNames[objectIndex])
                objectIndex+=1
                _label.setStyleSheet('background:yellow')
                _label.setText("离线")

            label_y=label_y+labelHeight+20
            font = QtGui.QFont()
            font.setPointSize(17)
            font.setBold(True)
            font.setWeight(75)
            _label.setFont(font)
            _label.setGeometry(label_x,label_y,labelWidth,labelHeight)
        
        self.label_33 = QtWidgets.QLabel(self)
        self.label_33.setGeometry(QtCore.QRect(300, 10, 701, 101))
        font = QtGui.QFont()
        font.setPointSize(45)
        font.setBold(True)
        font.setWeight(75)
        self.label_33.setFont(font)
        self.label_33.setStyleSheet("color: rgb(0, 85, 255);")
        self.label_33.setAlignment(QtCore.Qt.AlignCenter)
        self.label_33.setObjectName("label_33")
        self.textEdit = QtWidgets.QTextEdit(self)
        self.textEdit.setGeometry(QtCore.QRect(200, 460, 750, 250))
        font = QtGui.QFont()
        font.setPointSize(15)
        font.setBold(True)
        font.setWeight(75)
        self.textEdit.setFont(font)
        self.textEdit.setReadOnly(True)
        # self.textEdit.setVisible(False)
        self.textEdit.setObjectName("textEdit")
        self.label_34 = QtWidgets.QLabel(self)
        self.label_34.setGeometry(QtCore.QRect(30, 10, 200, 120))
        self.label_34.setObjectName("label_34")
        self.label_35 = QtWidgets.QLabel(self)
        self.label_35.setGeometry(QtCore.QRect(50, 265, 71, 31))
        font = QtGui.QFont()
        font.setPointSize(17)
        font.setBold(True)
        font.setWeight(75)
        self.label_35.setFont(font)
        self.label_35.setAlignment(QtCore.Qt.AlignCenter)
        self.label_35.setObjectName("label_35")
        self.label_36 = QtWidgets.QLabel(self)
        self.label_36.setGeometry(QtCore.QRect(50, 205, 71, 31))
        font = QtGui.QFont()
        font.setPointSize(15)
        font.setBold(True)
        font.setWeight(75)
        self.label_36.setFont(font)
        self.label_36.setAlignment(QtCore.Qt.AlignCenter)
        self.label_36.setObjectName("label_36")
        self.label_37 = QtWidgets.QLabel(self)
        self.label_37.setGeometry(QtCore.QRect(50, 325, 71, 31))
        font = QtGui.QFont()
        font.setPointSize(15)
        font.setBold(True)
        font.setWeight(75)
        self.label_37.setFont(font)
        self.label_37.setAlignment(QtCore.Qt.AlignCenter)
        self.label_37.setObjectName("label_37")

        self.label_38 = QtWidgets.QLabel(self)
        self.label_38.setGeometry(QtCore.QRect(50, 385, 71, 31))
        font = QtGui.QFont()
        font.setPointSize(15)
        font.setBold(True)
        font.setWeight(75)
        self.label_38.setFont(font)
        self.label_38.setAlignment(QtCore.Qt.AlignCenter)
        self.label_38.setObjectName("label_37")


        self.retranslateUi(self)
        QtCore.QMetaObject.connectSlotsByName(self)
        self.logoIni()
        self.runMonitorServer()

    def retranslateUi(self, MainWindow):
        _translate = QtCore.QCoreApplication.translate
        MainWindow.setWindowTitle(_translate("MainWindow", "MainWindow"))
        self.label_33.setText(_translate("MainWindow", "新厂E车间终测机械手状态"))
        self.label_34.setText(_translate("MainWindow", "pi icon"))
        self.label_35.setText(_translate("MainWindow", "B号手"))
        self.label_36.setText(_translate("MainWindow", "A号手"))
        self.label_37.setText(_translate("MainWindow", "C号手"))
        self.label_38.setText(_translate("MainWindow", "超声波"))

    def alterRobotState(self,robotNumber,state):
        pass

    def addRunMessage(self,msg):
        self.textEdit.append(QDateTime.currentDateTime().toString('yyyy-MM-dd hh:mm:ss')+' : '+msg)
        pass

    def runMonitorServer(self):
        self.monitorServer=MonitorServer()
        self.monitorServer.appendRunMsg.connect(self.addRunMessage)
        self.monitorServer.updateRobotState.connect(self.updateRobotLabel)
        self.monitorServer.run()

    def getObjectNames(self):
        paramPath="configure.yaml"
        confirmConfigureFile=QFile(paramPath)
        if not confirmConfigureFile.exists():
            QMessageBox.critical(self,'Critical','配置文件丢失！')
            exit(0)

        yamlTool=Yaml_Tool()
        params=yamlTool.getValue(paramPath)
        self.objectNames=params['robot'].split(',')

    def updateRobotLabel(self,_robot):
        if self.monitorServer.robotState[_robot]==RobotState.ANFANG:
            self.findChild(QLabel,_robot).setStyleSheet('background:red')
            self.findChild(QLabel,_robot).setText("安防报警")
        elif self.monitorServer.robotState[_robot]==RobotState.HIPOT:
            self.findChild(QLabel,_robot).setStyleSheet('background:red')
            self.findChild(QLabel,_robot).setText("高压报警")
        elif self.monitorServer.robotState[_robot]==RobotState.CATCH_ERROR:
            self.findChild(QLabel,_robot).setStyleSheet('background:red')
            self.findChild(QLabel,_robot).setText("未插入报警")
        elif self.monitorServer.robotState[_robot]==RobotState.OFFLINE:
            self.findChild(QLabel,_robot).setStyleSheet('background:yellow')
            self.findChild(QLabel,_robot).setText("离线")
        elif self.monitorServer.robotState[_robot]==RobotState.ONLINE:
            self.findChild(QLabel,_robot).setStyleSheet('background:green')
            self.findChild(QLabel,_robot).setText("正常")
        elif self.monitorServer.robotState[_robot]==RobotState.STOP:
            self.findChild(QLabel,_robot).setStyleSheet('background:red')
            self.findChild(QLabel,_robot).setText("停止")
        elif self.monitorServer.robotState[_robot]==RobotState.PAUSE:
            self.findChild(QLabel,_robot).setStyleSheet('background:red')
            self.findChild(QLabel,_robot).setText("中止")
        pass

    def logoIni(self):
        print('logoIni')
        self.logPixMap=QPixmap('PI_LOGO.png')
        self.fitPixMap=self.logPixMap.scaled(self.label_34.width(),
                                             self.label_34.height(),
                                             Qt.IgnoreAspectRatio,
                                             Qt.SmoothTransformation)
        self.label_34.setPixmap(self.fitPixMap)
        pass

    def closeEvent(self, a0: QtGui.QCloseEvent) -> None:
        choose = QMessageBox.question(self, 'Question', '确认关闭程序？', QMessageBox.Yes | QMessageBox.No,
                                      QMessageBox.Yes)
        if choose == QMessageBox.No:
            a0.ignore()

if __name__ == '__main__':
    app=QApplication(sys.argv)
    runGui=GUI()
    runGui.show()
    sys.exit(app.exec_())
